#!/usr/bin/env bash

PROJECT_DIR="@CMAKE_CURRENT_LIST_DIR@/../.."

echo "Running postbuild script..."

echo "$0: $(date)" > @CMAKE_CURRENT_BINARY_DIR@/postbuild.log

echo "Setting up venv in @CMAKE_CURRENT_BINARY_DIR@" >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log
python3 -m venv @CMAKE_CURRENT_BINARY_DIR@/.venv >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log

echo "Starting venv" >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log
source @CMAKE_CURRENT_BINARY_DIR@/.venv/bin/activate >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log

echo "Installing requirements" >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log
pip install -r ${PROJECT_DIR}/firmware/requirements.txt >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log

echo "Running post build python script" >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log
python3 ${PROJECT_DIR}/firmware/scripts/postbuild.py -s @APP_CODE_SIZE@ -i @CMAKE_CURRENT_BINARY_DIR@/application.bin -o @CMAKE_CURRENT_BINARY_DIR@/application_with_header.bin >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log

echo "Deactivating venv" >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log
deactivate >> @CMAKE_CURRENT_BINARY_DIR@/postbuild.log

echo "Postbuild done."
